name: CI/CD Complete - Build & Deploy Automatique

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # DÃ©clenchement manuel

env:
  REGISTRY_NAME: acr2048game
  IMAGE_NAME: 2048-game
  WEBAPP_NAME: webapp-2048-game-aya

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸšš Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ·ï¸ Generate version tag
      id: version
      run: |
        VERSION="v${{ github.run_number }}-$(echo ${{ github.sha }} | cut -c1-7)"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“‹ Version gÃ©nÃ©rÃ©e: $VERSION"
        
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    - name: ğŸ” Login to Azure Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY_NAME }}.azurecr.io
        username: ${{ env.REGISTRY_NAME }}
        password: ${{ secrets.ACR_PASSWORD }}
        
    - name: ğŸ—ï¸ Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: âœ… Build completed
      run: |
        echo "ğŸ‰ Image Docker crÃ©Ã©e avec succÃ¨s!"
        echo "ğŸ“¦ Image latest: ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest"
        echo "ğŸ“¦ Image versionnÃ©e: ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}"
        
    - name: ğŸš€ Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        images: ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
        
    - name: â³ Wait for deployment
      run: |
        echo "â³ Attente de la finalisation du dÃ©ploiement..."
        sleep 45
        
    - name: ğŸ§ª Test deployment
      run: |
        echo "ğŸ§ª Test de l'application dÃ©ployÃ©e..."
        
        # Test avec retry
        MAX_ATTEMPTS=5
        ATTEMPT=1
        
        while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
          echo "ğŸ” Tentative $ATTEMPT/$MAX_ATTEMPTS..."
          
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.WEBAPP_NAME }}.azurewebsites.net --max-time 30 || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Application accessible! (HTTP $HTTP_STATUS)"
            break
          else
            echo "â³ En attente... (HTTP $HTTP_STATUS)"
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "âš ï¸ L'application pourrait encore Ãªtre en cours de dÃ©marrage"
            else
              sleep 30
            fi
          fi
          
          ATTEMPT=$((ATTEMPT + 1))
        done
        
    - name: ğŸ“Š Deployment Summary
      run: |
        echo "ğŸ‰ DÃ‰PLOIEMENT TERMINÃ‰ AVEC SUCCÃˆS!"
        echo "=================================="
        echo "ğŸ“¦ Image dÃ©ployÃ©e: ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}"
        echo "ğŸŒ URL de l'application: https://${{ env.WEBAPP_NAME }}.azurewebsites.net"
        echo "ğŸ·ï¸ Version: ${{ steps.version.outputs.version }}"
        echo "ğŸ“… DÃ©ployÃ© le: $(date)"
        echo "ğŸ“‹ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Par: ${{ github.actor }}"
        echo ""
        echo "ğŸ® Votre jeu 2048 est maintenant en ligne!"